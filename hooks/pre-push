#!/usr/bin/env bash
set -euo pipefail

if ! command -v gitleaks &>/dev/null; then
  echo "gitleaks not found, skipping secret scan"
  exit 0
fi

z40="0000000000000000000000000000000000000000"

while read -r _local_ref local_oid _remote_ref remote_oid; do
  if [ "$local_oid" = "$z40" ]; then
    continue  # branch deletion, nothing to scan
  fi

  if [ "$remote_oid" = "$z40" ]; then
    range="$local_oid"  # new branch: scan all commits
  else
    range="$remote_oid..$local_oid"
  fi

  echo "Running gitleaks on commits ${range}..."
  if ! gitleaks git --no-banner -v --log-opts="$range" 2>&1; then
    echo ""
    echo "BLOCKED: gitleaks found potential secrets."
    echo "Review the findings above. If they are false positives,"
    echo "add them to a .gitleaksignore file in your repo root."
    exit 1
  fi
done
